name: CI - HtmlToPdf

on: [push, pull_request]

env:
  CONFIGURATION: Release
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: 1

jobs:
  ci:
    runs-on: windows-latest

    strategy:
      fail-fast: false
      matrix:
        TEST_SUITE: [Tests-All]
    timeout-minutes: 120

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: .NET 9.0
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 9.0.x

      - name: Build
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          $PSNativeCommandUseErrorActionPreference = $true

          Write-Host "Building with Configuration=${{ env.CONFIGURATION }}"
          .\build.ps1 -Configuration ${{ env.CONFIGURATION }}

          if ($LASTEXITCODE -ne 0) {
            Write-Error "Build failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }

      - name: Tests
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          $PSNativeCommandUseErrorActionPreference = $true

          Write-Host "Running tests with Configuration=${{ env.CONFIGURATION }}"
          .\tests.ps1 -Configuration ${{ env.CONFIGURATION }} -TestSuite ${{ matrix.TEST_SUITE }}

          if ($LASTEXITCODE -ne 0) {
            Write-Error "Tests failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }

      - name: Publish Artifacts
        if: always()   # garante que roda mesmo se testes falharem
        uses: actions/upload-artifact@v4
        with:
          name: 'ci_${{ matrix.TEST_SUITE }}_${{ env.CONFIGURATION }}'
          path: '.\\output\\'
